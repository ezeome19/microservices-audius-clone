<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}}</title>
    <link rel="stylesheet" href="/public/css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>

<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo-area" style="margin-bottom: 40px;">
                <h2
                    style="background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; font-size: 1.5rem;">
                    AUDIUS</h2>
            </div>

            <nav class="nav-links" style="display: flex; flex-direction: column; gap: 8px;">
                <a href="#feed" class="nav-item" data-tab="feed"
                    style="color: var(--text-secondary); padding: 10px 0; display: flex; align-items: center; gap: 12px;">
                    <i class="fa-solid fa-users" style="width: 20px;"></i> Feed
                </a>
                <a href="#trending" class="nav-item active" data-tab="trending"
                    style="font-weight: 600; padding: 10px 0; display: flex; align-items: center; gap: 12px;">
                    <i class="fa-solid fa-chart-line" style="width: 20px;"></i> Trending
                </a>
                <a href="#explore" class="nav-item" data-tab="explore"
                    style="color: var(--text-secondary); padding: 10px 0; display: flex; align-items: center; gap: 12px;">
                    <i class="fa-solid fa-compass" style="width: 20px;"></i> Explore
                </a>
                <a href="#wallet" class="nav-item" data-tab="wallet"
                    style="color: var(--text-secondary); padding: 10px 0; display: flex; align-items: center; gap: 12px;">
                    <i class="fa-solid fa-wallet" style="width: 20px;"></i> Wallet
                </a>
                <a href="#coins" class="nav-item" data-tab="coins"
                    style="color: var(--text-secondary); padding: 10px 0; display: flex; align-items: center; gap: 12px;">
                    <i class="fa-solid fa-coins" style="width: 20px;"></i> Coins
                </a>

                <p
                    style="text-transform: uppercase; font-size: 0.7rem; color: var(--text-muted); letter-spacing: 1px; margin: 20px 0 10px 0;">
                    Library</p>

                <a href="#favorites" class="nav-item" data-tab="favorites"
                    style="color: var(--text-secondary); padding: 10px 0; display: flex; align-items: center; gap: 12px;">
                    <i class="fa-solid fa-heart" style="width: 20px;"></i> Favorites
                </a>
                <a href="#playlists" class="nav-item" data-tab="playlists"
                    style="color: var(--text-secondary); padding: 10px 0; display: flex; align-items: center; gap: 12px;">
                    <i class="fa-solid fa-list-ul" style="width: 20px;"></i> Playlists
                </a>
                <a href="#" onclick="event.preventDefault(); showSettingsPage();" class="nav-item"
                    style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; color: var(--text-secondary); text-decoration: none; border-radius: 8px; transition: all 0.2s;">
                    <i class="fa-solid fa-gear" style="width: 20px;"></i> Settings
                </a>
            </nav>

            <div class="user-area"
                style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border-color);">
                <p style="color: var(--text-secondary); font-size: 0.9rem;">Start Listening</p>
                <div style="margin-top: 10px; margin-bottom: 10px;">
                    <button id="subscribeBtn" class="btn btn-primary"
                        style="width: 100%; font-size: 0.9rem; padding: 8px;">Subscribe to Premium</button>
                </div>
                <a href="/auth/logout" style="font-size: 0.8rem; color: var(--text-muted);">Log Out</a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <script>
                document.getElementById('subscribeBtn').addEventListener('click', async () => {
                    try {
                        const btn = document.getElementById('subscribeBtn');
                        btn.disabled = true;
                        btn.innerText = 'Processing...';

                        const response = await fetch('/api/payment/initialize', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ amount: 5000 })
                        });

                        const result = await response.json();

                        if (result.status === 'success' && result.data && result.data.publicKey) {
                            // Use Inline Flow
                            FlutterwaveCheckout({
                                public_key: result.data.publicKey,
                                tx_ref: result.data.tx_ref,
                                amount: result.data.amount,
                                currency: result.data.currency,
                                payment_options: "card, base, mobilemoneyghana, ussd",
                                customer: {
                                    email: result.data.customer.email,
                                    name: result.data.customer.name,
                                },
                                callback: function (data) {
                                    console.log("Subscription successful", data);
                                    window.location.href = `/payment/verify?transaction_id=${result.data.tx_ref}&status=successful`;
                                },
                                onclose: function () {
                                    btn.disabled = false;
                                    btn.innerText = 'Subscribe to Premium';
                                },
                                customizations: {
                                    title: "Audius Premium",
                                    description: "Subscription to Premium features",
                                    logo: "https://audius.co/logo.png",
                                },
                            });
                        } else if (result.status === 'success' && result.data && result.data.link) {
                            window.location.href = result.data.link;
                        } else {
                            alert('Payment initialization failed: ' + (result.message || 'Unknown error'));
                            btn.disabled = false;
                            btn.innerText = 'Subscribe to Premium';
                        }
                    } catch (error) {
                        console.error('Payment error:', error);
                        alert('An error occurred. Please try again.');
                        document.getElementById('subscribeBtn').disabled = false;
                        document.getElementById('subscribeBtn').innerText = 'Subscribe to Premium';
                    }
                });
            </script>
            <header style="margin-bottom: 32px; display: flex; justify-content: space-between; align-items: center;">
                <div class="search-bar" style="flex: 1; max-width: 600px;">
                    <input type="text" placeholder="Search for artists, tracks, playlists" id="globalSearch"
                        style="width: 100%; background: var(--bg-primary); border: 1px solid var(--border-color); padding: 12px 20px; border-radius: 8px; color: var(--text-primary); font-size: 0.95rem;">
                </div>
                <div style="display: flex; gap: 16px; align-items: center; position: relative;">
                    <button id="notifBell"
                        style="background: transparent; border: none; color: var(--text-secondary); font-size: 1.2rem; cursor: pointer; position: relative;">
                        <i class="fa-solid fa-bell"></i>
                        <span id="notifBadge"
                            style="display: none; position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: #FF3B30; border-radius: 50%; border: 2px solid var(--bg-primary);"></span>
                    </button>

                    <!-- Notifications Dropdown -->
                    <div id="notifDropdown"
                        style="display: none; position: absolute; top: 100%; right: 0; width: 320px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); z-index: 1000; margin-top: 12px; max-height: 480px; overflow-y: auto;">
                        <div
                            style="padding: 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                            <h4 style="margin: 0; font-size: 1rem; font-weight: 800;">Notifications</h4>
                            <button onclick="markAllAsRead()"
                                style="background: none; border: none; color: var(--accent-primary); font-size: 0.8rem; font-weight: 700; cursor: pointer;">Mark
                                all as read</button>
                        </div>
                        <div id="notifList" style="padding: 8px 0;">
                            <!-- Notifications will be injected here -->
                            <div style="text-align: center; padding: 24px; color: var(--text-muted);">
                                <i class="fa-solid fa-circle-notch fa-spin"
                                    style="font-size: 1.5rem; margin-bottom: 12px; display: block;"></i>
                                <p style="font-size: 0.9rem; margin: 0;">Checking for updates...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <section class="feed-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 id="feedTitle" style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);">Trending
                    </h3>
                    <div id="trendingFilters" style="display: flex; gap: 12px;">
                        <select id="timeFilter"
                            style="background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 6px; font-size: 0.9rem; cursor: pointer; font-weight: 600;">
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="allTime" selected>All Time</option>
                        </select>
                        <select id="genreFilter"
                            style="background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 6px; font-size: 0.9rem; cursor: pointer; font-weight: 600;">
                            <option value="">All Genres</option>
                            <option value="Electronic">Electronic</option>
                            <option value="Hip-Hop/Rap">Hip-Hop/Rap</option>
                            <option value="Pop">Pop</option>
                            <option value="Rock">Rock</option>
                            <option value="Jazz">Jazz</option>
                            <option value="Classical">Classical</option>
                        </select>
                    </div>
                </div>
                <div id="tracksContainer">
                    <!-- Placeholders for tracks -->
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div class="track-row"
                            style="display: flex; align-items: center; gap: 16px; padding: 12px; background: var(--bg-card); border-radius: 8px; transition: background 0.2s;">
                            <div style="width: 40px; height: 40px; background: #333; border-radius: 4px;"></div>
                            <div style="flex: 1;">
                                <h4 style="font-size: 1rem; margin: 0;">Supernova</h4>
                                <p style="font-size: 0.8rem; color: var(--text-secondary); margin: 0;">Skrillex</p>
                            </div>
                            <span style="color: var(--text-muted); font-size: 0.9rem;">3:42</span>
                        </div>
                        <div class="track-row"
                            style="display: flex; align-items: center; gap: 16px; padding: 12px; background: var(--bg-card); border-radius: 8px; transition: background 0.2s;">
                            <div style="width: 40px; height: 40px; background: #333; border-radius: 4px;"></div>
                            <div style="flex: 1;">
                                <h4 style="font-size: 1rem; margin: 0;">Strobe</h4>
                                <p style="font-size: 0.8rem; color: var(--text-secondary); margin: 0;">Deadmau5</p>
                            </div>
                            <span style="color: var(--text-muted); font-size: 0.9rem;">10:32</span>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Player will be injected by AudioPlayer.js -->
    </div>
    {{> commentModal}}
    <script src="/public/js/audio-player.js"></script>
    <script src="/public/js/personalized-feed.js"></script>
    <script src="/public/js/dashboard.js"></script>
    <script src="/public/js/tip-modal.js"></script>
    <script src="/public/js/settings-page.js"></script>
    <script src="/public/js/follow-artist.js"></script>
    <script src="/public/js/wallet-page.js"></script>
    <script src="/public/js/coin-page.js"></script>
</body>

</html>